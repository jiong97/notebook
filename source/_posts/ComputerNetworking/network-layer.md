---
title: 网络层
date: Aug 1, 2020 10:39 PM
categories: [ComputerNetworking]
enable: false
excerpt: '网络层具体实现了主机到主机的通信服务，网路中的每台主机和路由器都有网络层的部分。网络层在数据平面和控制平面分为了两大核心功能：转发（forwarding）和路由（routing）。转发为数据报到达路由器输入接口时，将其转发到其中一个输出接口。路由为网络层为数据报流向规划的一条路径。'
---

网络层具体实现了主机到主机的通信服务，网路中的每台主机和路由器都有网络层的部分。网络层在数据平面和控制平面分为了两大核心功能：转发（forwarding）和路由（routing）。转发为数据报到达路由器输入接口时，将其转发到其中一个输出接口。路由为网络层为数据报流向规划的一条路径。

因特网广泛使用的是网际协议（IP），分为版本4和版本6。

## 网际协议

### IPv4数据报格式

![/images/computer-networking/network-layer/Untitled.png](/images/computer-networking/network-layer/Untitled.png)

- version版本号指定了IP协议的版本 ，路由器根据版本号解释协议
- IHL首部长度。IPv4包含可变首部选项，所以这个4比特来确认载荷实际开始的地方。大多数数据包不包含选项，所以数据报头部一般为20字节
- TOS（DSCP、ECN）服务类型，区分不同类型的数据报。如可靠性、吞吐、时延
- 长度字段是包含首部的数据报总长度。虽然理论上为16比特，但数据报很少能超过1500字节的。
- 标识、标志、片偏移。这三个字段与IP分片有关
- TTL为经过路由器的跳数，每经过一个路由器，TTL减1，该字段为0时，数据报被丢弃
- 协议字段指示数据报到达目的地后应该交给哪运输层协议。6表示交给TCP，17标识交给UDP。该字段与运输层端口号类似，端口号绑定运输层与应用层，协议号绑定网络层与运输层
- 校验和用于检验数据报是否出错。由于TTL的存在，每经过一个路由器，校验和就要重新计算。校验和只对头部计算
- 选项字段允许IP首部被扩展，但很少使用。IPv6取消了选项

### 分片

并不是所有链路层协议都能承载相同大小的网络层数据报，以太网只能承载1500字节数据。链路层能承载的最大数据量称为MTU（最大传送单元，Maximum Transmission Unit），数据报封装在链路层帧中从一台路由器传送到下一台，每段链路可能使用不同的链路层协议，所以有不同的MTU。

如果MTU小于数据报大小，数据报会被会被分成多个更小的数据报，这些较小的数据报被称为片（Fragment）。片在到达目的运输层前需要重新组装，组装工作在端系统进行。

每生成一个数据报时，发送方将数据报标识标识号加1。当数据报要被分片时，每片具有初始数据报的源和目的地址与标识号。标识号可以确定哪些数据报实际上是同一较大数据报的分片。除了最后一个片的flag位被置为0，其余同一个较大数据报的分片被置为1，这用来告诉接收方确实受到了最后一个分片。片偏移指明该片在初始数据报的哪个位置。

### IPv4编址

主机与路由器之间的边界叫做接口，分组转发从一个链路转发到另一个链路，所以链路接口需要有IP地址。同时，主机接口也能向路由器发送报文，所以主机的接口也要有IP地址。IP地址与接口关联。

IP地址长度为32位比特，约40亿个。与因特网相连的主机和路由器接口，都必须有唯一的IP地址，地址的一部分需要由子网来决定。

### 有类地址

IP地址由高位的网络号与低位的主机号构成。根据比特值的不同范围划分为ABCDE五类地址。

![/images/computer-networking/network-layer/Untitled1.png](/images/computer-networking/network-layer/Untitled1.png)

classful address

该分类可以把整个IP地址空间描述为一个圆，通过不断地对半划分来进行分类。第一次划分一半，最高位为0的部分为A类地址，同时规定前8位为网络号。接着对剩余部分（最高位为1的部分）进行二分，划分出B类地址，其高位分别为10，同时定义其最高16位为网络号。对11部分进行二分，划分前缀110部分为C类地址，规定其前24位为网络号。对111部分进行二分，1110部分为D类，1111为E类，同时不规定网络号。D类为特殊用途，E类留作研究。

[特殊IP地址](https://www.notion.so/e82a11581e2b49a8b0904ebd1b56bfc7)

私有IP，这些地址不允许出现在公共互联网上

- 网络号为10的A类地址，有一个地址块
- 172.16-172.31的B类地址，有16个地址块
- 192.168.0-192.168.255的C类地址，有256个地址块

### 子网与子网划分

IP子网为具有相同网络号的IP地址，相同子网内主机可以不跨越路由器直接联通。IP地址分为两级，网络号确定后，子网大小也就由子网号确定了，为了更进一步划分子网，需要向主机号借用若干比特位，作为子网号。

![/images/computer-networking/network-layer/Untitled2.png](/images/computer-networking/network-layer/Untitled2.png)

如果想要将IP地址空间进一步划分四个子网，则可以借用主机号的前2位进行划分。

![/images/computer-networking/network-layer/Untitled3.png](/images/computer-networking/network-layer/Untitled3.png)

为了区分地址是否划分了子网，利用了多少位划分子网，利用子网掩码来计算子网地址。一个子网的32位子网掩码，对应于网络号与子网号的比特位，取值为1，主机号取值0。通过求与运算来计算子网地址。

![/images/computer-networking/network-layer/Untitled4.png](/images/computer-networking/network-layer/Untitled4.png)

### 无类地址划分（CIDR）

无类域间路由地址（Classless InterDomain Routing），消除了传统的ABC类地址划分，网络号子网号可以是任意长度，融合了子网地址和子网掩码。

CIDR地址形如a.b.c.d/x，其中/x为前缀，有时也同样称为子网掩码，定义了前x位为子网地址。如任何与子网223.1.1.0/24连接的主机，都要求其IP地址形如223.1.1.xxx。

CIDR提高了IPv4的分配效率，可以将多个有类地址子网进行合并，也可对一个子网进行再划分，也提高路由效率（路由聚合），可以对较大的子网记录路由信息，而不是记录一个个小的子网。如200.23.16.0/23，这个地址打破了C类地址前24个比特为网络号的划分，并将两个C类地址200.23.16.0与200.23.17.0进行合并。

![/images/computer-networking/network-layer/Untitled5.png](/images/computer-networking/network-layer/Untitled5.png)

a.b.c.d/x单一表项，就足以将数据包转发到该组织内的任何目的地。

### 路由聚合

形如a.b.c.d/x的IP地址，最高的x比特构成了网络地址，路由转发表中可能会存在改子网的许多IP地址项，如223.1.0.0/23与223.1.1.0/24可以共用相同的前缀223.1.0.0/22。一个组织通常被分配一个连续的地址块，a.b.c.d/x这个路由项可以将数据转发到该子网内的任何一台主机，且不用关心内部子网是如何划分，在组织内部转发时才考虑低位比特。

CIDR也有利于路由通告。例如，一个ISP可向外部通告对其发送某一前缀IP的数据。当地址不是按照层次分配时，脱离连续的地址块200.23.18.0/23不在另外一个ISP的地址之内，该ISP必须同时向外通告该地址块，这时就会两个ISP通告了该地址块，在转发时会选择匹配最长前缀的。

![/images/computer-networking/network-layer/Untitled6.png](/images/computer-networking/network-layer/Untitled6.png)

ISPs-R-Us has a more specific route to Organization

### DHCP

动态主机配置协议（Dynamic Host Configuration）允许主机自动获取IP地址。通过配置，能使某个主机每次与网络相连时都能够获取相同的IP，或临时分配一个IP。DHCP还允许一台主机得到子网掩码、默认网关（第一跳路由器地址）、本地DNS服务器。

最简单的情况下，每个子网都要一个DHCP服务器，否则需要一个中继代理，用于告知DHCP服务器的地址。如下图是一个具有代理功能的路由器，为子网223.1.1/24和223.1.3/24的到达客户提供DHCP服务。

![/images/computer-networking/network-layer/Untitled7.png](/images/computer-networking/network-layer/Untitled7.png)

DHCP client-server scenario

当一台主机接入网络时通过四个步骤来获取IP地址：

- DHCP服务器发现，新主机找到DHCP服务器的过程。客户通过UDP在67端口发送发现报文。由于初始状态下没有IP地址，更不用说DHCP服务器的IP地址。客户端使用广播地址255.255.255.255作为目的地址，使用0.0.0.0作为源地址。客户端将IP数据报发送给链路层，链路层将该帧广播到所有与该子网相连的子网
- DHCP服务器提供，服务器收到DHCP发现报文后，向客户端响应一个提供报文。该报文仍使用广播地址作为目的IP。DHCP提供报文含有事务ID、向客户推荐的IP地址、网络掩码、租用期。DHCP服务器可能有多个
- DHCP请求。客户端从多个服务器中选择一个，并向服务器发送DHCP请求报文进行响应，回显配置参数。请求报文的目的地址仍为广播地址，这可以通告其他DHCP服务器该主机决定从某个服务器申请，让这些服务器收回预分配的资源
- DHCP确认。服务器发送ACK报文进行响应，对参数进行确认

![/images/computer-networking/network-layer/Untitled8.png](/images/computer-networking/network-layer/Untitled8.png)

DHCP报文发送过程中使用的都是广播地址。

### 网络地址转换NAT

在网络内部中的主机使用私有IP地址，这种IP无法作为源和目的IP，无法向公共互联网发送和接受分组。NAT使能的路由器，对外具有唯一IP的单一设备，所有进入与离开网络内部的分组，都要经过该路由器，离开的分组具有相同的源IP，进入的分组具有相同的目的IP。当主机向因特网的某台服务器发送分组时，路由器会改写其中的源IP，替换为路由器的IP，然后生成一个新端口号，代替分组的源端口，然后发往因特网。路由器在内部记录源端口号、新端口号与源IP的映射关系。当服务器响应时，其目的地址时NAT路由器的IP，端口是路由器生成的端口，到达路由器，路由器检索其NAT转换表，将目的IP与目的端口进行替换，然后转发给内部主机。

### ICMP

因特网控制报文协议（ICMP）被主机和路由器用来彼此沟通网络层信息，最典型的是用来差错报告。比如使用HTTP、FTP、telnet会话时，在某个位置，IP路由器不能找到一条路径通往指定主机，就会向源主机类型3的“网络不可达”错误ICMP报文。

ICMP通常被认为是IP的一部分，但它确实IP数据报的载荷，就像TCP、UDP一样。

ICMP有一个类型字段和一个编码字段，并且包含引起改ICMP报文首次生成的IP数据报的首部和前8个字节。ICMP不仅能用于通知差错。

[ICMP报文类型](https://www.notion.so/ea95e64a8bd44295bef78a3919f5563f)

Traceroute程序可以跟踪一台主机到另一台主机之间的路由，它是由ICMP报文来实现的。为了判断源和目的之间的路由，Traceroute向目的主机发送一系列普通的IP数据报，同时为每个数据报启动定时器，每个数据报携带了不可达端口的UDP报文。将它们的TTL从1开始依次递增设置，当第n个报文到达第n个路由器时，第n个路由器观察到TTL正好过期，路由器丢弃改数据包，并向源发送ICMP告警报文。告警报文包含路由器的名字与它的IP地址，当ICMP报文到达源时，源主机根据定时器得到往返时延，得到第n台路由器名与IP地址。当源主机收到一个端口不可达的ICMP报文后，就知道不需再次发送探测分组了。标准的Traceroute为相同的TTL发送3个相同的分组，因此Traceroute为每个TTL提供3个结果。

Traceroute程序可以跟踪一台主机到另一台主机之间的路由，它是由ICMP报文来实现的。为了判断源和目的之间的路由，Traceroute向目的主机发送一系列普通的IP数据报，同时为每个数据报启动定时器，每个数据报携带了不可达端口的UDP报文。将它们的TTL从1开始依次递增设置，当第n个报文到达第n个路由器时，第n个路由器观察到TTL正好过期，路由器丢弃改数据包，并向源发送ICMP告警报文。告警报文包含路由器的名字与它的IP地址，当ICMP报文到达源时，源主机根据定时器得到往返时延，得到第n台路由器名与IP地址。当源主机收到一个端口不可达的ICMP报文后，就知道不需再次发送探测分组了。标准的Traceroute为相同的TTL发送3个相同的分组，因此Traceroute为每个TTL提供3个结果。

### IPv6

IPv6将地址扩张到128位，除了单播及多播地址外，还引入了任播地址（anycast address），可以将数据报交付给一组主机中的任意一个。许多IPv4的字段被弃用或作为选项，形成了固定的40字节首部。

![/images/computer-networking/network-layer/Untitled9.png](/images/computer-networking/network-layer/Untitled9.png)

IPv6 datagram format

- 版本，4比特标识IP版本号
- 流量类型，8比特，与IPv4的TOS类似
- 流标签，20比特表示一条数据报的流
- 有效载荷长度，16比特无符号整数，定长首部的后的字节数

IPv6数据报不允许在中间路由器分片与组装。这种操作只允许在源和目的上进行，如果数据报太大，路由器仅需丢弃改报文，并向发送方发送分组太大的ICMP报文，于是发送方可以用较小的数据报重新发送。分片与组装是个耗时的过程，将此功能放到端系统中，加快转发速度。

移除了首部校验和，因特网运输层与数据链路层协议执行了校验操作，网络层执行改操作时多余的，同时TTL的存在，使得每转发一次就要重计算校验和，也是耗时操作。

选项字段不再是标准IP的一部分，移到了下一首部的位置，也就是说运输层协议的首部可以是IP分组的下一首部，删除选项字段使IP成为定长的40字节。

### IPv4到IPv6

IPv6可以做向后兼容处理，发送、接收、路由IPv4数据报，但以部署的IPv4系统却不能够处理IPv6数据报。有多种方法将IPv6整合进IPv4网络中。

一种方法是双栈，使用改方法的IPv6节点还具有完整的IPv4实现，它具有发送和接受两种数据报的能力。IPv6/IPv4结点必须具有两种IP地址。此外，还必须确定另一个结点是IPv6使能，还是仅具有IPv4使能，可以使用DNS解决。若要解析的节点名字是IPv6使能的，DNS会返回IPv6地址，否则返回IPv6。发送接受双方如果有一个仅为IPv4使能的，则必须使用IPv4。从IPv6到IPv4转换时，IPv6的一些IPv6特定字段会丢失，数据字段被复制到IPv4的数据段中，并作地址映射。因此，两个IPv6使能的端系统相互发送消息，由于中间路由器的存在，接收方收到的数据报并不能包含初始IPv6数据报的所有字段（如flow）。

另一种方法是建隧道，是另一种双栈方案，能解决上述问题。假定两个IPv6结点要发送数据，中间经由IPv4结点互联，中间的IPv4结点称为隧道。隧道的发送方端的IPv6结点能将整个IPv6数据报放在IPv4数据报的数据字段中。

### 路由选择

不管是数据报服务还是虚电路服务，网络层必须为发送双方确定发送路径。与主机相连的路由器叫做默认路由器，又称第一跳路由器，主机每发送一个分组，分组被传到默认路由器。源和目的主机的默认路由器叫做源路由器和目的路由器。

路由算法的目的是，从一组路由器及其链路，选择一条从源路由器到目的路由器的最有路径。路由算的广义分类是根据该算法是全局式的还是分散式的。

全局式路由选择算法要求所有结点之间的连通性及所有链路的费用作为输入。这要求在算法开始之前，要求以某种方式获得这些信息，这种算法也叫链路状态算法。实践中，让每个结点向网络中所有其他结点广播链路状态分组，这同常由链路状态广播算法完成。广播的结果是所有的结点具有了该网络等同的、完整的视图，每个结点都能运行算法，计算最优路径。可以使用图算法（Dijkstra）来计算。每个结点存放着到达目的地的最优路径的下一条结点，转发表依据此信息构建。

分散式路由选择算法以迭代、分布式的方式计算路径。没有结点的完整信息，每个结点仅有与其直接相连的链路信息，通过迭代计算，并与相连结点交换信息，逐渐计算出到达某一或一组目的结点的最优路径。距离向量路由算法（Distance Vector，DV）是其中一种。DV算法是迭代、异步的。DV算法不断地向最近的邻居转发数据报，在结点中维护到所有邻居的开销，与该节点到所有节点的开销。

第二种广义的分类是根据算法是静态的还是动态的。静态路由选择算法随着时间的流逝，路由变化非常缓慢，通常是人工配置。动态路由选择算法根据网络流量的变化或拓扑的变化改变选择路径。

### 层次路由

如果将网络只看作一个互联的路由器集合，执行相同的路由选择算法，那么很难将路由器区分开。并且随着规模的增大，转发表所需的内存也会变得庞大，路由器间转发的链路状态分组也会挤占许多带宽。每个ISP也希望按照自己的意愿管理路由器（运行某种特定的路由选择算法），或对外部隐藏其网络内部的组织面貌，并且与其它外部网络连接起来。

这些问题可以通过将路由器组织进自治系统（Autonomous System，AS）来解决。每个AS通常由一组处在相同控制下的路由器组成。通常由一个ISP中的路由器构成一个AS。某些ISP将网络划分成多个AS，并将AS互联。每个AS具有一个全局的A号所标识，由ICANN分配。

### OSPF&RIP

OSPF与RIP协议被用于AS内部路由选择协议。

OSPF是一种链路状态协议，它使用后洪泛链路状态信息与Dijkstra算法，这样路由器可以构建整个AS的完整拓扑。

### BGP

在相同AS内的源和目的之间交换分组时，分组遵循的路径完全由AS内路由选择协议决定。当分组跨越AS时，AS内和AS间路由选择协议同时起作用，AS间的路由信息由BGP（Border Gateway Protocol）协议决定。

在BGP中，分组不是到达一个特定的目的地址，而是一个CIDR化的前缀，表示一个子网或子网集合。作为AS间路由选择协议的BGP，为每台路由器提供了：

- 从邻居AS获得前缀可达信息。BGP允许每个子网向因特网的其余部分通告它的存在。
- 确定到某前缀的最佳路由。

![BGP例子](/images/computer-networking/network-layer/Untitled10.png)

一个AS中，一台路由器要么时网关路由器，要么是内部路由器。网关路由器位于AS边缘，与其他AS的网关路由器相连。AS间的BGP信息是由网关路由器发送的。上图例子中，为了将AS3中的前缀x通告给AS1和AS2，3a向2c发送BGP报文”AS3 x“，网关路由器2c随后向AS内的所有其他路由器发送BGP报文”AS3 x“。网关路由器2a接下来向网关路由器1c发送BGP报文”AS2 AS3 x“。最后，1c向AS内的其他所有路由器发送BGP报文”AS2 AS3 x“。这个过程后，AS1和AS2就知道通往x的AS路径。

路由器通过BGP连接通告前缀时，会在前缀中包括一些BGP属性，称为路由。两个重要的属性是AS-PATH和NEXT-HOP。AS-PATH是通告经过的AS列表，当通告经过一个AS时，将其ASN加入AS-PATH中。如AS1到x有两条路，”AS1 AS2“和”AS3“。AS-PATH可以用于检测通告环路，当一个AS在一个AS-PATH中发现自己时，它将拒绝通告。NEXT-HOP时AS-PATH的起始路由器接口的IP地址。对应于AS1到x的两条BGP路由为，2a与3d左侧接口IP。

从一个给定的路由器到一个目的子网可能有多条BGP路由。将选择到达NEXT-HOP最小开销的路由，将分组尽快地送出其AS。这种方法被成为热土豆路由。实践中，BGP使用更加复杂的算法，采用一些列规则来消除候选路由。分别为：偏好设置、使用距离向量路由选择算法选择具有最小AS跳数的路由、热土豆路由、BGP标识。

![BGP路由选择策略](/images/computer-networking/network-layer/simple-BGP-policy-scenario.png)

当一个AS只与一个AS相连，则称为桩网络；如果与多个AS相连，则称为多宿桩网络。流经多宿桩网络的流量不一定源于该AS本身。比如Y的流量可以经过X进入到W。X为了防止转发B与C之间的流量，X可以拒绝向C和B通告BGP“XB...”和“XC...”。

在B和C之间（ISP），如果B向C通告了通往A的BGP信息，那么Y的流量可以通过B到达A。商业ISP之间之间通常不相互转发其它ISP的流量，除非有对等协议，对等协议通常对外保密。

### IP任播

BGP除了作为AS间路由选择协议，还用于实现IP任播（anycast）。通常用于DNS中。DNS服务器能够遍及全世界的DNS服务器上复制记录，当用户访问复制的内容时，会被指向最近的服务器。

IP任播阶段，多台DNS服务器会被指派相同的IP地址，并且使用标准的BGP向外通告改IP地址。当某台网关路由器收到相同IP的多个BGP通告，它将这些通告理解为相同物理位置的不同路径。当配置路由表时，路由选择算法将计算最佳路径。实践中，CDN通常不使用IP任播，因为BGP的路由选择，将导致相同的TCP连接的不同分组到达Web服务器的不同实例。根DNS服务器只有十数个，但却有100多个实例。